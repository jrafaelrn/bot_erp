name: GCP - Bot

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  deploy:

    name: 'Deploy to GCP'
    runs-on: ubuntu-latest
    environment: prod
    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      IMAGE_NAME: gcr.io/${{ secrets.GCP_PROJECT_ID }}/bot:latest
    
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      
      # Git checkout
      - name: checkout
        uses: 'actions/checkout@v3'
        
      # Authenticate with GCP
      - name: AuthGCP
        uses: 'google-github-actions/auth@v0'
        with:
          credentials_json: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # Auth
      - name: Auth with Service Account
        run: gcloud auth activate-service-account ${{ secrets.GOOGLE_EMAIL_ACCOUNT }} --key-file ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
      
      # Configure Docker
      - name: Configure Docker
        run: gcloud auth configure-docker --quiet

      # Build Image
      - name: Build Image
        run: docker build -t $IMAGE_NAME src/bot/

      #Push Image
      - name: Push Image
        run: docker push $IMAGE_NAME

      # Deploy Image
      - name: Deploy Image
        run: gcloud run deploy bot --image $IMAGE_NAME --port 47221 --max-instances 1

  
